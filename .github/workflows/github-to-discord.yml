name: GitHub ‚Üí Discord

on:
  push:
  pull_request:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Push Event to Discord
        if: github.event_name == 'push'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          COMMIT_MSGS=""
          for COMMIT in $(seq 0 $((${#GITHUB_EVENT_COMMITS[@]} - 1))); do
            :
          done
          # Como $GITHUB_EVENT_COMMITS n√£o √© acess√≠vel diretamente no bash, pegamos via arquivo JSON
          COMMIT_LIST=$(cat $GITHUB_EVENT_PATH | grep '"message":' | sed 's/.*"message": "\(.*\)",/\1/')
          COMMIT_URLS=$(cat $GITHUB_EVENT_PATH | grep '"url":' | grep commits | sed 's/.*"url": "\(.*\)"/\1/')
          paste <(echo "$COMMIT_LIST") <(echo "$COMMIT_URLS") | while IFS=$'\t' read -r MSG URL; do
            COMMIT_MSGS="$COMMIT_MSGS- $MSG ($URL)\n"
          done

          TEXT="üì¢ **${REPO}** recebeu um push de **${USER}**:\n${COMMIT_MSGS}"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send PR Event to Discord
        if: github.event_name == 'pull_request'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          TEXT="üìù **${USER}** abriu um Pull Request em **${REPO}**: ${TITLE} - ${URL}"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send Release Event to Discord
        if: github.event_name == 'release'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          NAME="${{ github.event.release.name }}"
          URL="${{ github.event.release.html_url }}"
          TEXT="üöÄ **${USER}** publicou uma nova release em **${REPO}**: ${NAME} - ${URL}"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
