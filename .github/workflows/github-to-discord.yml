name: GitHub ‚Üí Discord

on:
  push:
  pull_request:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Push Event to Discord
        if: github.event_name == 'push'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          
          COMMITS=$(jq -r '.commits[]? | "- \(.message) (\(.url))"' "$GITHUB_EVENT_PATH")

          if [ -z "$COMMITS" ]; then
            COMMITS="(nenhum commit listado)"
          fi

          TEXT="üì¢ **${REPO}** recebeu um push de **${USER}**:\n${COMMITS}"
          
          ESCAPED_TEXT=$(echo "$TEXT" | sed 's/"/\\"/g')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$ESCAPED_TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send PR Event to Discord
        if: github.event_name == 'pull_request'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          TEXT="üìù **${USER}** abriu um Pull Request em **${REPO}**: ${TITLE} - ${URL}"
          ESCAPED_TEXT=$(echo "$TEXT" | sed 's/"/\\"/g')
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$ESCAPED_TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send Release Event to Discord
        if: github.event_name == 'release'
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          NAME="${{ github.event.release.name }}"
          URL="${{ github.event.release.html_url }}"
          TEXT="üöÄ **${USER}** publicou uma nova release em **${REPO}**: ${NAME} - ${URL}"
          ESCAPED_TEXT=$(echo "$TEXT" | sed 's/"/\\"/g')
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$ESCAPED_TEXT\"}" \
               "${DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
